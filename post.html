<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新しい投稿</title>
    <link rel="stylesheet" href="./css/styles.css">
</head>
<body>
    <div class="container">
        <h1>新しい投稿</h1>
        <div class="form">
            <textarea id="content" placeholder="投稿内容を入力してください"></textarea>
            <input type="file" id="image" accept="image/*">
            <button id="post-btn" class="button">投稿</button>
            <a href="timeline.html" class="button">タイムラインに戻る</a>
        </div>
    </div>

    <script>
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        document.getElementById('post-btn').onclick = async function () {
            const content = document.getElementById('content').value.trim();
            const imageFile = document.getElementById('image').files[0];

            if (!content && !imageFile) {
                alert('投稿内容または画像を入力してください');
                return;
            }

            const instanceUrl = getCookie('instance_url');
            const accessToken = getCookie('access_token');

            if (!instanceUrl || !accessToken) {
                alert('ログイン情報がありません（Cookieが設定されていません）');
                return;
            }

            const proxy = 'https://cors-0x10.online:4443/';
            let mediaId = null;

            try {
                if (imageFile) {
                    const mediaForm = new FormData();
                    mediaForm.append('file', imageFile);

                    const mediaRes = await fetch(proxy + instanceUrl + '/api/v2/media', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: mediaForm
                    });

                    const mediaData = await mediaRes.json();
                    if (!mediaRes.ok) throw new Error(mediaData.error || 'メディアアップロード失敗');

                    mediaId = mediaData.id;
                }

                const statusForm = new FormData();
                statusForm.append('status', content || ''); // 空投稿対策
                if (mediaId) statusForm.append('media_ids[]', mediaId);

                const postRes = await fetch(proxy + instanceUrl + '/api/v1/statuses', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: statusForm
                });

                const postData = await postRes.json();
                if (!postRes.ok) throw new Error(postData.error || '投稿に失敗しました');

                alert('投稿が送信されました');
                window.location.href = 'timeline.html';

            } catch (error) {
                alert('エラーが発生しました: ' + error.message);
            }
        };
    </script>
</body>
</html>
