<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>新しい投稿 - Simpdon クライアント</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/styles.css">
    <link rel="icon" href="./ico/simpdon.ico">
</head>
<body>
    <div class="container">
        <h1>新しい投稿</h1>
        <textarea id="post-text" rows="5" cols="40" placeholder="投稿内容を入力してください..."></textarea><br>
        <input type="file" id="media" accept="image/*"><br><br>
        <a href="javascript:void(0);" onclick="submitPost()" class="button">投稿する</a>
    </div>

    <script>
        // Polyfill for iOS 6
        if (!XMLHttpRequest.prototype.sendAsBinary) {
            XMLHttpRequest.prototype.sendAsBinary = function (data) {
                var bytes = Array.prototype.map.call(data, function(c) {
                    return c.charCodeAt(0) & 0xff;
                });
                this.send(new Uint8Array(bytes));
            };
        }

        function getCookie(name) {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var c = cookies[i].trim();
                if (c.indexOf(name + '=') === 0) return c.substring(name.length + 1);
            }
            return '';
        }

        function submitPost() {
            var text = document.getElementById('post-text').value;
            var file = document.getElementById('media').files[0];
            var instanceUrl = getCookie('instanceUrl');
            var accessToken = getCookie('accessToken');

            if (file) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    uploadImage(e.target.result, file.name, function(mediaId) {
                        sendPost(text, mediaId);
                    });
                };
                reader.readAsDataURL(file);
            } else {
                sendPost(text, null);
            }
        }

        function uploadImage(dataUrl, filename, callback) {
            var boundary = '----WebKitFormBoundary' + Math.random().toString(36).substr(2);
            var parts = dataUrl.split(',');
            var mime = parts[0].match(/:(.*?);/)[1];
            var binary = atob(parts[1]);

            var body = '';
            body += '--' + boundary + '\r\n';
            body += 'Content-Disposition: form-data; name="file"; filename="' + filename + '"\r\n';
            body += 'Content-Type: ' + mime + '\r\n\r\n';
            body += binary + '\r\n';
            body += '--' + boundary + '--\r\n';

            var xhr = new XMLHttpRequest();
            var instanceUrl = getCookie('instanceUrl');
            var accessToken = getCookie('accessToken');

            xhr.open('POST', 'https://cors-0x10.online:4443/' + instanceUrl + '/api/v2/media', true);
            xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
            xhr.setRequestHeader('Content-Type', 'multipart/form-data; boundary=' + boundary);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var res = JSON.parse(xhr.responseText);
                    callback(res.id);
                } else if (xhr.readyState === 4) {
                    alert('画像のアップロードに失敗しました');
                }
            };
            xhr.sendAsBinary(body);
        }

        function sendPost(text, mediaId) {
            var xhr = new XMLHttpRequest();
            var instanceUrl = getCookie('instanceUrl');
            var accessToken = getCookie('accessToken');
            var body = 'status=' + encodeURIComponent(text);
            if (mediaId) body += '&media_ids[]=' + encodeURIComponent(mediaId);

            xhr.open('POST', 'https://cors-0x10.online:4443/' + instanceUrl + '/api/v1/statuses', true);
            xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    alert('投稿が完了しました');
                    window.location.href = 'timeline.html';
                } else if (xhr.readyState === 4) {
                    alert('投稿に失敗しました');
                }
            };
            xhr.send(body);
        }
    </script>
</body>
</html>
