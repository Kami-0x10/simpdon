<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>新しい投稿 - Simpdon クライアント</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/styles.css">
    <link rel="icon" href="./ico/simpdon.ico">
</head>
<body>
    <div class="container">
        <h1>新しい投稿</h1>
        <form id="post-form" enctype="multipart/form-data" method="post">
            <textarea id="post-text" name="status" rows="5" cols="40" placeholder="投稿内容を入力してください..."></textarea><br>
            <label for="media">画像を選択:</label><br>
            <input type="file" id="media" name="media" accept="image/*"><br><br>
            <a href="javascript:void(0);" onclick="submitPost()" class="button">投稿する</a>
        </form>
    </div>

    <script>
        if (!String.prototype.trim) {
            String.prototype.trim = function() {
                return this.replace(/^\s+|\s+$/g, '');
            };
        }

        function getCookie(name) {
            var nameEq = name + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i].replace(/^\s+/, '');
                if (c.indexOf(nameEq) === 0) return c.substring(nameEq.length, c.length);
            }
            return "";
        }

        function submitPost() {
            var instanceUrl = getCookie('instanceUrl');
            var accessToken = getCookie('accessToken');
            var text = document.getElementById('post-text').value;
            var fileInput = document.getElementById('media');
            var file = fileInput.files.length > 0 ? fileInput.files[0] : null;

            if (!text && !file) {
                alert("投稿内容または画像を入力してください");
                return;
            }

            if (file) {
                uploadMedia(file, instanceUrl, accessToken, function(mediaId) {
                    postStatus(text, mediaId, instanceUrl, accessToken);
                });
            } else {
                postStatus(text, null, instanceUrl, accessToken);
            }
        }

        function uploadMedia(file, instanceUrl, accessToken, callback) {
            var xhr = new XMLHttpRequest();
            var formData = new FormData();
            formData.append('file', file);

            xhr.open("POST", instanceUrl + "/api/v2/media", true);
            xhr.setRequestHeader("Authorization", "Bearer " + accessToken);

            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        var response = JSON.parse(xhr.responseText);
                        callback(response.id);
                    } else {
                        alert("画像のアップロードに失敗しました");
                    }
                }
            };

            xhr.send(formData);
        }

        function postStatus(text, mediaId, instanceUrl, accessToken) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", instanceUrl + "/api/v1/statuses", true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.setRequestHeader("Authorization", "Bearer " + accessToken);

            var body = "status=" + encodeURIComponent(text);
            if (mediaId) {
                body += "&media_ids[]=" + encodeURIComponent(mediaId);
            }

            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        alert("投稿が完了しました");
                        window.location.href = 'timeline.html';
                    } else {
                        alert("投稿に失敗しました");
                    }
                }
            };

            xhr.send(body);
        }
    </script>
</body>
</html>
