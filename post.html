<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <link rel="icon" href="./ico/global.ico">
    <script src="./js/json2.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新しい投稿 - Simpdon クライアント</title>
    <link rel="stylesheet" href="./css/styles.css">
</head>

<body>
    <div class="container">
        <h1>新しい投稿</h1>
        <div class="form">
            <textarea id="content" placeholder="投稿内容を入力してください"></textarea>
            <a href="javascript:void(0);" id="post-btn" class="button">投稿</a>
        </div>
    </div>

    <!-- iframeを追加 -->
    <iframe id="hidden-frame" name="hidden-frame" style="display:none;"></iframe>

<script>
    document.getElementById('post-btn').onclick = function () {
        var content = document.getElementById('content').value.trim();
        var imageFile = document.getElementById('image').files[0];

        if (!content && !imageFile) {
            alert('投稿内容または画像を入力してください');
            return;
        }

        const apiUrl = 'http://localhost:6553/api/v1/statuses';  // サーバーURL
        const token = localStorage.getItem('auth_token');  // ローカルストレージからトークンを取得

        if (!token) {
            alert('ログインされていません。');
            return;
        }

        // フォームデータを作成
        const formData = new FormData();
        if (content) formData.append('content', content);
        if (imageFile) formData.append('image', imageFile);

        // fetchを使ってPOSTリクエストを送信
        fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,  // 認証トークンを追加
            },
            body: formData,  // フォームデータを送信
            credentials: 'include',  // セッションのためにクッキーを含める
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.error || '不明なエラー');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.id) {
                alert('投稿が送信されました');
                window.location.href = 'timeline.html';  // 投稿後にタイムラインページに遷移
            } else {
                alert('投稿の送信に失敗しました');
            }
        })
        .catch(error => {
            alert('投稿の送信に失敗しました。エラー: ' + error.message);  // エラー内容をアラート表示
        });
    };
</script>

</body>

</html>
